import{fabric as e}from"fabric";import t from"eventemitter3";import i from"lodash/minBy";class r{_x;_y;isDirty;static fromFlatPoint([e,t]){return new this({x:e,y:t})}constructor({x:e,y:t}){this._x=e,this._y=t,this.isDirty=!1}toFlatPoint(){return[this.x,this.y]}toFabricPoint(){return new e.Point(...this.toFlatPoint())}toLeftTop(){return{left:this.x,top:this.y}}checkNear(e,t){return t=t??6,Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}checkSame(e){return this.x===e.x&&this.y===e.y}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}plus(e){return this.move({dx:e.x,dy:e.y}),this}minus(e){return this.move({dx:-e.x,dy:-e.y}),this}scale(e){return this.x=this.x*e,this.y=this.y*e,this}clone(){return new r(this)}move({dx:e,dy:t},i){return i=i?this.clone():this,e&&(i.x=i.x+e),t&&(i.y=i.y+t),i}get x(){return this._x}set x(e){this._x!==e&&(this.isDirty=!0),this._x=e}get y(){return this._y}set y(e){this._y!==e&&(this.isDirty=!0),this._y=e}}class n extends r{}class s extends r{}class o{renderer;listeners={};constructor(e){this.renderer=e}addListener(e,t,i){this.listeners[e]=[...this.listeners[e]??[],t],this.renderer.view.addEventListener(e,t,i)}removeListener(e,t,i){var r=this.listeners[e]?.indexOf(t);r&&0<=r&&(this.listeners[e]?.slice(r,1),this.renderer.view.removeEventListener(e,t,i))}clear(){Object.entries(this.listeners).forEach((([e,t])=>{t.forEach((t=>{this.removeListener(e,t)}))}))}}class a extends e.Object{}const d=(e,t)=>!(!e||!t||e.uid!==t.uid),h=e=>!(e instanceof a),c=e=>{var t=getComputedStyle(e),i=Number(/^\d*/.exec(t.paddingTop)[0]),r=Number(/^\d*/.exec(t.paddingBottom)[0]),n=Number(/^\d*/.exec(t.paddingLeft)[0]);t=Number(/^\d*/.exec(t.paddingRight)[0]);return{width:e.clientWidth-i-r,height:e.clientHeight-n-t}},l=(e,{strokeBorder:t,stroke:i,strokeBorderScale:r})=>{t&&i&&(e._renderStroke=function(e){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(e),e.save(),this.strokeUniform&&this.group){const t=this.getObjectScaling();e.scale(1/t.scaleX,1/t.scaleY)}else this.strokeUniform&&e.scale(1/this.scaleX,1/this.scaleY);e.strokeStyle=t,e.lineWidth=this.strokeWidth*(r??1.6),e.stroke(),e.strokeStyle=i,e.lineWidth=this.strokeWidth,e.stroke(),e.restore()})},u=(e,t)=>{var i;return"object"==typeof e&&null!==e&&(!(!(i=Object.getOwnPropertyDescriptor(e,t))||"function"!=typeof i.set)||u(Object.getPrototypeOf(e),t))},b=new Set,v=e=>{var t=Math.ceil(1e12*Math.random());return e?e+"-"+t:""+t},g=e=>{let t=v(e);for(;b.has(t);)t=v(e);return b.add(t),t};class m{renderer;attachedRenderable;children;constructor(e){this.children=e.children??[],this.renderer=e.renderer??null,this.attachedRenderable=e.attachedRenderable}setRenderer(e){this.renderer=e,this.children.forEach((t=>{d(t,this.attachedRenderable)||(e?t.renderer||e.add(t):t.renderer&&t.renderer.remove(t))}))}add(...e){this.children.push(...e),e.forEach((e=>{d(e,this.attachedRenderable)||(e.parent=this.attachedRenderable,this.renderer&&this.renderer.add(e))}))}remove(...e){this.children=this.children.filter((t=>!e.some((e=>d(t,e))))),e.forEach((e=>{this.renderer&&this.renderer.remove(e)}))}removeByName(e){this.children.filter((t=>t.name===e)).forEach((e=>this.remove(e)))}getChildByName(e){return this.children.find((t=>t.name===e))??null}dispose(){this.remove(...this.children)}get size(){return this.children.length}}class p{renderer;constructor(e){this.renderer=e}}class f extends p{doesSupportPointerEvents=!!window.PointerEvent;mouse;_mouseOverRenderablePath=[];get mouseOverRenderablePath(){return Object.freeze(this._mouseOverRenderablePath)}set mouseOverRenderablePath(e){this._mouseOverRenderablePath=e}canvasElementEventEmitter;pointer;isPointerShown;currentCursor;_emitter=new t;constructor(e){super(e),this.pointer=null,this.isPointerShown=!0,this.currentCursor="default",this.mouse={position:new s({x:0,y:0}),point:new r({x:0,y:0}),boundaryRelativePoint:new r({x:0,y:0}),isDown:!1},this.canvasElementEventEmitter=new o(e),this._init()}_init(){this._addEvents(),this.addListener("pointermove",this._renderPointer)}_renderPointer=e=>{this.pointer&&(this.isPointerShown?(this.pointer.object.visible||(this.pointer.object.visible=!0),this.pointer.object.scale(1/this.renderer.viewportScale),this.pointer.object.set(e.boundaryRelativePoint.toLeftTop())):this.pointer.object.visible=!1,this.renderer.requestRender())};setCursor(e,{immediate:t=!0}={}){this.renderer.fabric.setCursor(e),this.renderer.fabric.defaultCursor=e,this.renderer.view.style.cursor=e,this.currentCursor=e,t?this.renderer.render():this.renderer.requestRender()}setPointer(e,t={hideCursor:!0}){this.removePointer(),e?(e.object.scale(1/this.renderer.viewportScale),this.renderer.add(e),this.pointer=e,t?.hideCursor&&(this.setCursor("none"),this.pointer.object.hoverCursor="none")):this.setCursor("default")}showPointer(e){this.pointer&&(this.isPointerShown=!0,this.pointer.object.visible=!0,e?.point&&this.pointer.object.set({...e.point.toLeftTop()}),this.renderer.render())}hidePointer(){this.pointer&&(this.isPointerShown=!1,this.pointer.object.visible=!1,this.renderer.render())}removePointer(){this.pointer&&(this.renderer.remove(this.pointer),this.pointer=null)}addListener(e,t){return this._emitter.addListener(e,t),()=>this.removeListener(e,t)}removeListener(e,t){this._emitter.removeListener(e,t)}clearListeners(){this._emitter.removeAllListeners()}_addEvents(){this.canvasElementEventEmitter.addListener("wheel",this._onWheel,!0),this.canvasElementEventEmitter.addListener("dblclick",this._onDblClick,!0),this.renderer.fabric.on("mouse:move",this._onFabricMouseMove),this.doesSupportPointerEvents?(this.canvasElementEventEmitter.addListener("pointermove",this._onPointerMove,!0),this.canvasElementEventEmitter.addListener("pointerdown",this._onPointerDown,!0),this.canvasElementEventEmitter.addListener("pointerup",this._onPointerUp,!0),this.canvasElementEventEmitter.addListener("pointerover",this._onPointerOver,!0),this.canvasElementEventEmitter.addListener("pointerleave",this._onPointerOut,!0)):(this.canvasElementEventEmitter.addListener("mousemove",this._onPointerMove,!0),this.canvasElementEventEmitter.addListener("mousedown",this._onPointerDown,!0),this.canvasElementEventEmitter.addListener("mouseout",this._onPointerUp,!0),this.canvasElementEventEmitter.addListener("mouseover",this._onPointerOver,!0),this.canvasElementEventEmitter.addListener("mouseup",this._onPointerOut,!0))}_removeEvents(){this.canvasElementEventEmitter.clear(),this._emitter.removeAllListeners(),this.renderer.fabric.off("mouse:move",this._onFabricMouseMove)}_onFabricMouseMove=e=>{e=e.target,this.mouseOverRenderablePath=e?this.renderer.utils.getRenderablePathOfFabricObject(e):[]};_onPointerMove=e=>{e=this._normalizeToPointerEvent(e),this.mouse.point=e.point,this.mouse.position=e.position,this.mouse.boundaryRelativePoint=e.boundaryRelativePoint,this.renderer.utils.checkPointIsInsideViewport(e.point)&&this._emitter.emit(e.type,e)};get onPointerMove(){return this._onPointerMove}set onPointerMove(e){this._onPointerMove=e}_onPointerDown=e=>{e=this._normalizeToPointerEvent(e),this.mouse.isDown=!0,this.renderer.utils.checkPointIsInsideViewport(e.point)&&this._emitter.emit(e.type,e)};_onPointerUp=e=>{e=this._normalizeToPointerEvent(e),this.mouse.isDown=!1,this.renderer.isRenderableModifying&&(this.renderer.isRenderableModifying=!1),this.renderer.utils.checkPointIsInsideViewport(e.point)&&this._emitter.emit(e.type,e)};_onPointerOver=e=>{e=this._normalizeToPointerEvent(e),this.renderer.utils.checkPointIsInsideViewport(e.point)&&this._emitter.emit(e.type,e)};_onPointerOut=e=>{e=this._normalizeToPointerEvent(e),this._emitter.emit(e.type,e)};_onWheel=e=>{e=this._normalizeToPointerEvent(e),this._emitter.emit(e.type,e)};_onDblClick=e=>{e=this._normalizeToPointerEvent(e),this.renderer.utils.checkPointIsInsideViewport(e.point)&&this._emitter.emit(e.type,e)};_normalizeToPointerEvent(e){var t=e;return t.position=new s({x:e.x,y:e.y}),t.point=this.renderer.utils.mapPositionToPoint(t.position),t.boundaryRelativePoint=this.renderer.utils.mapPointToBoundaryRelativePoint(t.point),t.renderablePath=this.mouseOverRenderablePath,t.targetRenderable=t.renderablePath[0]??null,this.doesSupportPointerEvents||(t.pointerType||(t.pointerType="mouse"),t.pressure||(t.pressure=.5),t.type.includes("mouse")&&(t.type=t.type.replace("mouse","pointer"))),t}dispose(){this._removeEvents()}}class y{listeners={};_emitter=new t;renderer;constructor(e){this.renderer=e,this._init()}_init(){this.addEvents()}addEvents(){this.renderer.interaction.addListener("pointermove",this._onPointerOut),this.renderer.interaction.addListener("pointermove",this._onPointerOver)}_onPointerOver=e=>{e.renderablePath.forEach((t=>{var i;t&&t.isPointerOver&&!t.isPrevPointerOver&&(i={type:"pointer:over",target:e.renderablePath[0],currentTarget:t,renderer:this.renderer,renderablePath:e.renderablePath},t.isPrevPointerOver=!0,this._emitter.emit("pointer:over",i))}))};_onPointerOut=e=>{var t=this.renderer.renderables.filter((e=>!e.isPointerOver));t.filter((e=>e.isPrevPointerOver)).forEach((t=>{var i={type:"pointer:out",target:e.renderablePath[0],currentTarget:t,renderer:this.renderer,renderablePath:e.renderablePath};t.isPrevPointerOver=!1,this._emitter.emit("pointer:out",i)})),t.forEach((t=>{e.renderablePath.includes(t)||(t.isPrevPointerOver=!1)}))};addListener(e,t){switch(e){case"moving":case"rotating":case"scaling":case"modified":case"modifying":case"skewing":case"resizing":this._addModificationEventListener(e,t);break;case"selection:updated":this._addSelectionEventListener(e,t);break;case"renderable:added":case"renderable:removed":this._addExistenceEventListener(e,t);break;case"pointer:click":case"pointer:out":case"pointer:over":this._addPointerEventListener(e,t);break;case"text:changed":this._addTextEventListener(e,t);break;default:e.startsWith("custom:"),this._addCustomEventListener(e,t)}}_addModificationEventListener(e,t){let i=()=>{},r=t;if("modifying"===e){let e=null;const n={moving:!1,rotating:!1,scaling:!1};let s={...n};r=i=>{!0===s[i.type]?(t(i),s=n):s[i.type]=!0,e&&window.clearTimeout(e),i.type="modifying",Object.values(s).every(Boolean)?(t(i),s=n):e=window.setTimeout((()=>{t(i),e&&window.clearTimeout(e)}),5)},this._addModificationEventListener("moving",r),this._addModificationEventListener("rotating",r),this._addModificationEventListener("scaling",r),this._addModificationEventListener("skewing",r),this._addModificationEventListener("resizing",r),i=()=>{this.removeListener("moving",r),this.removeListener("rotating",r),this.removeListener("scaling",r),this.removeListener("skewing",r),this.removeListener("resizing",r)}}else{const r=i=>{(i=this._normalizeFabricModificationEvent(e,i))&&t(i)};this.renderer.fabric.on("object:"+e,r),i=()=>{this.renderer.fabric.off("object:"+e,r)}}this._registerListenerStore(e,{listener:t,removeListener:i})}_addSelectionEventListener(e,t){let i=null;const r=r=>{i&&window.clearTimeout(i),i=window.setTimeout((()=>{var n=(r?.selected??[])[0],s=(r?.deselected??[])[0];s={renderer:this.renderer,type:e,prev:s?this.renderer.utils.getRenderablePathOfFabricObject(s)[0]??null:null,prevFabricObject:s,next:n?this.renderer.utils.getRenderablePathOfFabricObject(n)[0]??null:null,nextFabricObject:n};t(s),i&&window.clearTimeout(i)}),10)};this.renderer.fabric.on("selection:updated",r),this.renderer.fabric.on("selection:created",r),this.renderer.fabric.on("selection:cleared",r),this._registerListenerStore(e,{listener:t,removeListener:()=>{this.renderer.fabric.off("selection:updated",r),this.renderer.fabric.off("selection:created",r),this.renderer.fabric.off("selection:cleared",r)}})}_addExistenceEventListener(e,t){this._emitter.addListener(e,t),this._registerListenerStore(e,{listener:t,removeListener:()=>this._emitter.removeListener(e,t)})}_addPointerEventListener(e,t){let i=()=>{};if("pointer:click"===e){const r=i=>{var r=i.targetRenderable;r&&(r={type:e,target:r,currentTarget:i.renderablePath[i.renderablePath.length-1],renderer:this.renderer,renderablePath:r?i.renderablePath.slice(i.renderablePath.indexOf(r)):i.renderablePath},t(r))};this.renderer.interaction.addListener("pointerup",r),i=()=>this.renderer.interaction.removeListener("pointerup",r)}else"pointer:over"===e?(this._emitter.addListener("pointer:over",t),i=()=>this._emitter.removeListener("pointer:over",t)):"pointer:out"===e&&(this._emitter.addListener("pointer:out",t),i=()=>this._emitter.removeListener("pointer:out",t));this._registerListenerStore(e,{listener:t,removeListener:i})}_addTextEventListener(e,t){const i=i=>{i=i.target;var r=this.renderer.utils.getRenderablePathOfFabricObject(i);i={renderer:this.renderer,type:e,text:i.text,renderablePath:r,target:r[0],currentTarget:r[r.length-1]};t(i)};this.renderer.fabric.on("text:changed",i),this._registerListenerStore(e,{listener:t,removeListener:()=>{this.renderer.fabric.off("text:changed",i)}})}_addCustomEventListener(e,t){this._emitter.addListener(e,t),this._registerListenerStore(e,{listener:t,removeListener:()=>this._emitter.removeListener(e,t)})}_registerListenerStore(e,{listener:t,removeListener:i}){this.listeners[e]=[...this.listeners[e]??[],{listener:t,removeListener:i}]}fireEvent(e,t,i){"moving"===e||"rotating"===e||"scaling"===e||"modified"===e||"modifying"===e?this.renderer.fabric.fire("object:moving",{target:t.main.object,indirectModification:i?.indirectModification??!0}):"selection:updated"===e?this.renderer.fabric.fire("selection:updated",{selected:t?.main.object}):"renderable:added"===e||"renderable:removed"===e?this._emitter.emit(e,{type:e,target:t,renderer:this}):e.startsWith("custom:")&&this._emitter.emit(e,{type:e,target:t,renderer:this,...i})}removeListener(e,t){e=this.listeners[e]?.find((e=>e.listener===t)),e?.removeListener&&e?.removeListener()}clearListeners(){Object.entries(this.listeners).forEach((([e,t])=>{t?.forEach((({listener:t})=>{this.removeListener(e,t)}))}))}_normalizeFabricModificationEvent(e,t){var i=t.target&&this.renderer.utils.getRenderablePathOfFabricObject(t.target);return i&&0!==i.length?{renderer:this.renderer,type:e,target:i[0],renderablePath:i,indirectModification:t?.indirectModification??!1}:null}dispose(){this.clearListeners()}}class P{listeners={};attachedRenderable;renderableEventSystem;constructor(e,t){this.renderableEventSystem=e.renderableEvent,this.attachedRenderable=t}addListener=(...e)=>{this._registerListenerStore(e[0],e[1]),this.renderableEventSystem.addListener(...e)};removeListener=(...e)=>{this.renderableEventSystem.removeListener(...e)};clearListener=()=>{Object.entries(this.listeners).forEach((([e,t])=>{t?.forEach((({listener:t})=>{this.removeListener(e,t)}))}))};fireEvent=(...e)=>{this.renderableEventSystem.fireEvent(...e)};_registerListenerStore(e,t){this.listeners[e]=[...this.listeners[e]??[],t]}dispose(){this.clearListener()}}class w{_emitter=new t;renderer;constructor(e){this.renderer=e}addListener(e,t){switch(e){case"background:updated":this._addBackgroundEventListener(e,t);break;case"panning":case"zooming":this._addModificationListener(e,t)}}removeListener(e,t){switch(e){case"background:updated":this._removeBackgroundEventListener(e,t);break;case"panning":case"zooming":this._removeModificationListener(e,t)}}_addBackgroundEventListener(e,t){this._emitter.addListener(e,t)}_addModificationListener(e,t){this._emitter.addListener(e,t)}_removeBackgroundEventListener(e,t){this._emitter.removeListener(e,t)}_removeModificationListener(e,t){this._emitter.removeListener(e,t)}fireEvent(e,t){var i={renderer:this.renderer,type:e};switch(e){case"background:updated":case"panning":case"zooming":this._emitter.emit(e,{...i,...t})}}dispose(){}}const _={lockScalingFlip:!0};class E{uid;options;type;renderer;object;parent;container;data;context={};_zIndex;_event;isPrevPointerOver;get isPointerOver(){return!!this.renderer?.interaction.mouseOverRenderablePath.includes(this)}constructor(e){this.options={..._,...e},this.uid=e.uid??g(),this.type=e.type??"",this.parent=e?.parent??null,this.data=e.data??{},this.object=new a,this.container=new m({attachedRenderable:this,children:[this]}),this._initContainer(),this._zIndex=0,this.zIndex=e.zIndex??0,this.isVisible=e.isVisible??!0,this.isPrevPointerOver=this.isPointerOver,e.renderer&&e.renderer.add(this)}_onRendererAdded(e){}_onRendererRemoved(e){}_added(e){this.renderer=e,this._event=new P(e,this),this.container.setRenderer(e),this._onRendererAdded(e)}_removed(e){this.container.setRenderer(null),this._onRendererRemoved(e),this.renderer=void 0}moveForward(){this.renderer?.moveRenderable(this)}moveBackward(){this.renderer?.moveRenderable(this,!0)}getChild(e){return this.container.getChildByName(e)}get event(){return this._event}get name(){return this.object.name??""}set name(e){this.object.name=e}get ancestorCount(){let e=0,t=this.parent;for(;t;)e++,t=t.parent;return e}get zIndex(){return this._zIndex}set zIndex(e){this._zIndex=9999<e?9999:e%1e4}get isVisible(){return!!this.object.visible}set isVisible(e){this.object.visible=e}get globalZIndex(){if(this.options.localZIndexAsGlobal)return this.zIndex;let e=this.zIndex,t=this.parent;for(;t;)e=t.zIndex+e/1e4,t=t.options.localZIndexAsGlobal?null:t.parent;return e}}class x{renderer;constructor(e){this.renderer=e}mapPointToPercentPoint(e){var{x:e,y:t}=e;return new n({x:e/this.renderer.width*100,y:t/this.renderer.height*100})}mapPercentPointToPoint(e){var{x:e,y:t}=e;return new r({x:e*this.renderer.width/100,y:t*this.renderer.height/100})}mapPositionToPoint(e){var{left:t,top:i}=this.renderer.view.getBoundingClientRect();return new r({x:(e.x-t)/this.renderer.backgroundScale,y:(e.y-i)/this.renderer.backgroundScale})}mapPointToPosition(e){var{left:t,top:i}=this.renderer.view.getBoundingClientRect();return new s({x:e.x*this.renderer.backgroundScale+t,y:e.y*this.renderer.backgroundScale+i})}mapPointToBoundaryRelativePoint(e){return new r({x:(this.renderer.boundaryLeftTopPoint.x+e.x)/this.renderer.scale,y:(this.renderer.boundaryLeftTopPoint.y+e.y)/this.renderer.scale})}mapBoundaryRelativePointToPoint(e){return new r({x:e.x*this.renderer.scale-this.renderer.boundaryLeftTopPoint.x,y:e.y*this.renderer.scale-this.renderer.boundaryLeftTopPoint.y})}getRenderablePathOfFabricObject(e){var t=[];let i=this.renderer.renderables.find((t=>t.uid===(e.group||e).data?.uid))??null;for(;i;)t.unshift(i),i=i.parent;return t}checkPointIsInsideViewport(e,t){var[t,i]=t??[0,0];return e.x>=t&&e.y>=i&&e.x<=this.renderer.viewportWidth-t&&e.y<=this.renderer.viewportHeight-i}projectPointToNearBoundary(e,t){let{x:n,y:s}=e;var{boundaryWidth:e,boundaryHeight:o}=this.renderer,a={top:s/o,bottom:(o-s)/o,left:n/e,right:(e-n)/e},[t,d]=t??[0,0],[a]=i(Object.entries(a),(e=>e[1]));return"top"===a?s=d:"bottom"===a?s=o-d:n="left"===a?t:e-t,new r({x:n,y:s})}getRendererViewParentElement(){let e=this.renderer.view.parentElement;return"canvas-container"===e?.className?e.parentElement:e}}const L={};class j{options;_view;constructor(e){this.options={...L,...e},this._view=e.view}get width(){return this.view.width}get height(){return this.view.height}get view(){return this._view}}class k extends j{uid=g();fabric;renderables;interaction;rendererEvent;renderableEvent;utils=new x(this);backgroundImageRatio;isRenderableMoving;isBackgroundDrawing;parentElement;isRenderableModifying=!1;constructor(t){super(t),this.parentElement=this.utils.getRendererViewParentElement();var{width:i,height:r}={...c(this.parentElement),...this.options};this.fabric=new e.Canvas(this.options.view,{selection:!1,preserveObjectStacking:!0,backgroundColor:t.backgroundColor,perPixelTargetFind:!0,targetFindTolerance:9,width:i,height:r,enableRetinaScaling:!0}),this.backgroundImageRatio=this.rendererRatio,this.isRenderableMoving=!1,this.isBackgroundDrawing=!1,this.renderables=[],this.interaction=new f(this),this.renderableEvent=new y(this),this.rendererEvent=new w(this),this.resize(this.width,this.height),this._initEvents()}_initEvents(){this.renderableEvent.addListener("modifying",(e=>{e.indirectModification||(this.isRenderableModifying=!0)})),this.renderableEvent.addListener("modified",(()=>{this.isRenderableModifying=!1}))}async drawBackground(t,i={}){if(i={fit:"fill",...i},this.isBackgroundDrawing=!0,this.backgroundImage&&(this.fabric.remove(this.backgroundImage),this.fabric.backgroundImage=void 0,this.render()),t){const n={objectCaching:!1,moveCursor:"default",hoverCursor:"default",selectable:!1,centeredRotation:!1,originX:"left",originY:"top",type:"background",...i},s=()=>{this.rendererEvent.fireEvent("background:updated",{backgroundImage:this.backgroundImage})};if("string"==typeof t){const o=new Image;o.crossOrigin="anonymous",o.src=t+(t.startsWith("https:")?"?t="+Date.now().toString():""),await new Promise((e=>o.onload=e)),await new Promise((async t=>{var a=new e.Image(o,n),d=(this.fabric.backgroundImage=a).width,h=a.height;if(this.backgroundImageRatio=d/h,this.options.fitToBackgroundImage)this.fabric.setHeight(this.width/this.backgroundImageRatio);else{if(a.originX="center",a.originY="center",a.left=this.width/2,a.top=this.height/2,"fill"===i.fit)a.scaleX=this.width/d,a.scaleY=this.height/h;else if("contain"===i.fit){const e=i.maxWidth??this.width,t=i.maxHeight??this.height;a.scaleToWidth(e),a.getScaledHeight()>t&&a.scaleToHeight(t)}this.moveTo(new r({x:0,y:0}))}this.zoomTo(1,r.fromFlatPoint([0,0])),this.isBackgroundDrawing=!1,s(),t(a)}))}else{const{videoWidth:i,videoHeight:o}=t,a=new e.Image(t,{...n,width:i,height:o});this.backgroundImageRatio=i/o,this.fabric.setHeight(this.width/this.backgroundImageRatio),this.fabric.setBackgroundImage(a,(()=>{this.zoomTo(1,r.fromFlatPoint([0,0])),this.isBackgroundDrawing=!1})),s()}}else this.isBackgroundDrawing=!1}render(){this.fabric.renderAll()}requestRender(){this.fabric.requestRenderAll()}add(e,t){if(h(e)&&this.addFabricObject(e.object),e._added(this),t?.skipSorting)this.renderables.push(e);else{const t=this._findInsertedIdxOfRenderable(e);((e,t,i)=>{e.splice(i,0,t)})(this.renderables,e,t),e.object.moveTo(t)}t?.skipFireEvent||this.renderableEvent.fireEvent("renderable:added",e)}addBulk(e,t){e.forEach((e=>this.add(e,{skipSorting:!0,skipFireEvent:!0}))),t?.skipSorting||this.sortRenderables(),t?.skipFireEvent||e.forEach((e=>this.renderableEvent.fireEvent("renderable:added",e)))}_findInsertedIdxOfRenderable(e,t){let i=this.renderables.length;for(let s=0;s<this.renderables.length;s++){var r=this.renderables[s],n=e.globalZIndex-r.globalZIndex;if(e!==r&&t?n<=0:n<0){i=s;break}}return i}addFabricObject(e){this.fabric.add(e)}remove(e,t){this.removeBulk([e],t)}removeBulk(e,t){const i=[];e.forEach((e=>{h(e)&&this.removeFabricObject(e.object),e._removed(this);var t=this.renderables.findIndex((t=>d(t,e)));0<=t&&i.push(t)})),((e,t)=>{for(let i=t.length-1;0<=i;i--)e.splice(t[i],1)})(this.renderables,i),t?.skipFireEvent||e.forEach((e=>this.renderableEvent.fireEvent("renderable:removed",e))),t?.skipSorting||this.sortRenderables()}removeFabricObject(...e){this.fabric.remove(...e)}getActiveRenderable(){var e=this.fabric.getActiveObject();if(e)return this.utils.getRenderablePathOfFabricObject(e)[0]}setActiveRenderable(e){if(e!==this.getActiveRenderable())if(e){let t=e.main;for(;t.main!==t;)t=t.main;this.fabric.setActiveObject(t.object),this.render()}else this.fabric.discardActiveObject()}zoomTo(e,t){var i=this.boundaryLeftTopPoint,r=this.scale;this.fabric.zoomToPoint(t.clone().scale(this.backgroundScale),e*this.backgroundScale),t=this.boundaryLeftTopPoint.minus(i).scale(1/this.scale);this.rendererEvent.fireEvent("zooming",{moved:t,lastScale:r,currentScale:this.scale})}moveTo(e){var t=this.boundaryLeftTopPoint;e=e.clone().scale(this.backgroundScale),this.fabric.absolutePan(e.toFabricPoint()),this.requestRender(),e=this.boundaryLeftTopPoint.minus(t).scale(1/this.scale);this.rendererEvent.fireEvent("panning",{moved:e})}async resize(e,t,i){if(i={drawBackground:!0,...i},this.fabric.setWidth(e),this.fabric.setHeight(t),this.requestRender(),i.drawBackground&&this.backgroundImage){const e=this.backgroundImage.getElement();await this.drawBackground(e instanceof HTMLVideoElement?e:this.backgroundImage.getSrc())}return Promise.resolve()}sortRenderables(){this.renderables.sort(((e,t)=>{var i=e.globalZIndex-t.globalZIndex;return 0==i?e.context.isBackward&&t.context.isBackward||e.context.isForward&&t.context.isForward?0:e.context.isBackward||t.context.isForward?-1:1:i})),this.renderables.forEach((({context:e})=>{delete e.isForward,delete e.isBackward})),this.renderables.forEach(((e,t)=>{h(e)&&e.object.moveTo(t)})),this.requestRender()}moveRenderable(e,t=!1,i=!0){e.container.children.forEach((i=>{i===e?(e.context.isBackward=t,e.context.isForward=!t):this.moveRenderable(i,t,!1)})),i&&this.sortRenderables()}dispose(){this._disposeSystems()}_disposeSystems(){this.interaction.dispose(),this.renderableEvent.dispose()}get upperCanvas(){return this._view.nextElementSibling}get view(){return this.upperCanvas??this._view}get lowerCanvas(){return this._view}get width(){return this.view.getBoundingClientRect().width}get height(){return this.view.getBoundingClientRect().height}get viewportWidth(){return this.width/this.backgroundScale}get viewportHeight(){return this.height/this.backgroundScale}get boundaryWidth(){return this.viewportWidth*this.scale}get boundaryHeight(){return this.viewportHeight*this.scale}get viewportScale(){return this.fabric.getZoom()}get scale(){return this.viewportScale/this.backgroundScale}get backgroundScale(){if(this.options.fitToBackgroundImage){var e=this.backgroundImage?.getElement();if(e instanceof HTMLVideoElement)return this.width/e.videoWidth;if(e instanceof HTMLImageElement)return this.width/e.width}return 1}get backgroundImageScale(){var e=this.backgroundImage?.getElement(),t=e?.width;return e instanceof HTMLVideoElement?this.width/t:e instanceof HTMLImageElement?this.backgroundImage?.getScaledWidth()/t:1}get rendererRatio(){return this.width/this.height}get boundaryLeftTopPoint(){return new r(this.fabric.calcViewportBoundaries().tl).scale(this.scale).clone()}get backgroundImage(){return this.fabric.backgroundImage}}class R extends E{object;eventListeners={isSizeFixed:{zooming:e=>{this.object.scale(1/e.currentScale),this.renderer?.requestRender(),this.event.fireEvent("scaling",this)}},isPositionFixed:{panning:e=>{this.object.left=this.object.left+e.moved.x,this.object.top=this.object.top+e.moved.y,this.renderer?.requestRender(),this.event.fireEvent("moving",this)},zooming:e=>{this.object.left=e.lastScale/e.currentScale*this.object.left+e.moved.x,this.object.top=e.lastScale/e.currentScale*this.object.top+e.moved.y,this.renderer?.requestRender(),this.event.fireEvent("moving",this)}}};constructor(e){super(e),this.object=this._create(),this.object.borderColor="#329EFF",this.object.cornerColor="white",this.object.cornerStrokeColor="#329EFF",this.object.data={uid:this.uid},this.object.name=this.options.name??"",this.isSelectable=this.options.selectable??!0}_initContainer(){}update(e){Object.entries(e).forEach((([e,t])=>{if(u(this,e))this[e]=t;else{if(!(e in this.object))throw new Error(e+" setter is not implemented.");this.object[e]=t}})),this.renderer?.requestRender(),this._afterUpdate()}_afterUpdate(){}_onRendererAdded(e){this.addEvents(e)}_onRendererRemoved(e){this.removeEvents(e)}addEvents(e){this.options.isSizeFixed&&e.rendererEvent.addListener("zooming",this.eventListeners.isSizeFixed.zooming),this.options.isPositionFixed&&(e.rendererEvent.addListener("zooming",this.eventListeners.isPositionFixed.zooming),e.rendererEvent.addListener("panning",this.eventListeners.isPositionFixed.panning)),this.options.relativeToViewport&&(this.object.left=(e.boundaryLeftTopPoint.x+this.point.x)/e.scale,this.object.top=(e.boundaryLeftTopPoint.y+this.point.y)/e.scale)}removeEvents(e){this.options.isSizeFixed&&e.rendererEvent.removeListener("zooming",this.eventListeners.isSizeFixed.zooming),this.options.isPositionFixed&&(e.rendererEvent.removeListener("zooming",this.eventListeners.isPositionFixed.zooming),e.rendererEvent.removeListener("panning",this.eventListeners.isPositionFixed.panning))}get width(){return this.object.width}get scaledWidth(){return this.object.width*this.object.scaleX}get height(){return this.object.height}get scaledHeight(){return this.object.height*this.object.scaleY}get shadow(){var e=this.object.shadow;return"string"==typeof e?e:e?.toString()}set shadow(e){this.object.shadow=e}get opacity(){return this.object.opacity}set opacity(e){this.object.opacity=e}get angle(){return this.object.angle}set angle(e){this.object.angle=e}get rotation(){return e.util.degreesToRadians(this.angle)}get rotationPoint(){return"center"}set rotationPoint(e){}get sizeControllerType(){return this.object.cornerStyle}set sizeControllerType(e){this.object.cornerStyle=e}get sizeControllerColor(){return this.object.cornerColor}set sizeControllerColor(e){this.object.cornerColor=e}get sizeControllerSize(){return this.object.cornerSize}set sizeControllerSize(e){this.object.cornerSize=e}get hoverCursor(){return this.object.hoverCursor}set hoverCursor(e){this.object.hoverCursor=e}get moveCursor(){return this.object.moveCursor}set moveCursor(e){this.object.moveCursor=e}get hasBorder(){return this.object.hasBorders}set hasBorder(e){this.object.hasBorders=e}get borderColor(){return this.object.borderColor}set borderColor(e){this.object.borderColor=e}get borderScaleFactor(){return this.object.borderScaleFactor}set borderScaleFactor(e){this.object.borderScaleFactor=e}get padding(){return this.object.padding}set padding(e){this.object.padding=e}get paintFirst(){return this.object.paintFirst}set paintFirst(e){this.object.paintFirst=e}get selectionBackgroundColor(){return this.object.selectionBackgroundColor}set selectionBackgroundColor(e){this.object.selectionBackgroundColor=e}get isMovementDisabled(){return!(!this.object.lockMovementX||!this.object.lockMovementY)}set isMovementDisabled(e){this.object.lockMovementX=e,this.object.lockMovementY=e}get isRotationDisabled(){return!!this.object.lockRotation}set isRotationDisabled(e){this.object.lockRotation=e}get isScalingDisabled(){return!(!this.object.lockScalingX||!this.object.lockScalingY)}set isScalingDisabled(e){this.object.lockScalingX=e,this.object.lockScalingY=e}get isModificationDisabled(){return this.isMovementDisabled&&this.isRotationDisabled&&this.isScalingDisabled}set isModificationDisabled(e){this.isMovementDisabled=e,this.isRotationDisabled=e,this.isScalingDisabled=e}get scale(){return this.object.scaleY}set scale(e){this.object.scale(e)}get point(){return new r({x:this.object.left,y:this.object.top})}get centerPoint(){return new r(this.object.getCenterPoint())}get isSelectable(){return this.object.selectable??!1}set isSelectable(t){t?(this.object.hoverCursor=e.Object.prototype.hoverCursor,this.object.moveCursor=e.Object.prototype.moveCursor):(this.object.hoverCursor="default",this.object.moveCursor="default"),this.object.selectable=t}get left(){return this.object.left}get top(){return this.object.top}get fill(){return this.object.fill}get stroke(){return this.object.stroke}get main(){return this}}class S extends R{static type="Line";type=S.type;_points;editingMode="size";roundPoints=!0;constructor(e){super({type:S.type,...e}),this._points=e.points}_create(){var t=this.options.selectable?{}:{hoverCursor:"default"};return new e.Line(this.options.points.map((e=>e.toFlatPoint())).flat(),{objectCaching:!1,hasBorders:this.options.hasBorder??!0,transparentCorners:!1,borderScaleFactor:2,originX:"center",originY:"center",lockScalingFlip:!0,strokeUniform:!0,hasRotatingPoint:!1,...t,...this.options})}_onRendererAdded(e){this.addEvents(e),e.renderableEvent.addListener("modifying",this._onModifying),e.renderableEvent.addListener("modified",this._onModified),e.interaction.addListener("dblclick",this._onDblclick),l(this.object,this.options)}_onRendererRemoved(e){this.removeEvents(e),e?.interaction.removeListener("dblclick",this._onDblclick),e.renderableEvent.removeListener("modifying",this._onModifying),e.renderableEvent.addListener("modified",this._onModified)}_onDblclick=e=>{this.options.changeModeByDblclick&&d(e.targetRenderable,this)&&("coordinate"===this.editingMode?this.changeToSizeMode():this.changeToCoordinateMode(),this.renderer?.render())};_onModifying=e=>{if(e.renderablePath.includes(this)){const e=this._normalizePoints();this._points[0]=e[0],this._points[1]=e[1],this.updatePoint({initialPoint:this._points[0],terminalPoint:this._points[1]})}};_moveLineToBeInsideBoundary(){if(!this.renderer)return this._points;var e=this.object,{x1:t,x2:i,y1:r,y2:n,scaleX:s,scaleY:o}=e,a=e.left,d=e.top,i=Math.abs((i-t)*s),t=Math.abs((n-r)*o),s=this.renderer.viewportWidth,n=this.renderer.viewportHeight;s<i&&(e.x1=0,e.x2=s),n<t&&(e.y1=0,e.y2=n),a-i/2<0&&(e.left=i/2),s<a+i/2&&(e.left=s-i/2),d-t/2<0&&(e.top=t/2),n<d+t/2&&(e.top=n-t/2)}_normalizePoints(){if(!this.renderer)return this._points;this.options.restrictInsideBoundary&&this._moveLineToBeInsideBoundary();var e=this.object,{x1:t,x2:i,y1:n,y2:s,scaleX:o,scaleY:a}=e,d=e.left;e=e.top,this.object.scaleX=1,this.object.scaleY=1,d=[new r({x:d-(i-t)/2*o,y:e-(s-n)/2*a}),new r({x:d+(i-t)/2*o,y:e+(s-n)/2*a})];return this.roundPoints?d.map((e=>e.round())):d}_onModified=e=>{if(e.renderablePath.includes(this)&&this.renderer){this._normalizePoints();const e=this._points[0].clone().plus(this._points[1]).scale(.5),t=this._points.map((t=>((e,t,i)=>(t=t*Math.PI/180,e=e.clone().minus(i),new r({x:e.x*Math.cos(t)-e.y*Math.sin(t),y:e.x*Math.sin(t)+e.y*Math.cos(t)}).plus(i)))(t,this.object.angle,e)));this.updatePoint({initialPoint:t[0],terminalPoint:t[1]}),this.object.angle=0,this.object.setCoords()}};updatePoint(e,t){if(e.initialPoint){const{x:t,y:i}=this.roundPoints?e.initialPoint.round():e.initialPoint;this.object.set({x1:t,y1:i}),this.points[0]=new r({x:t,y:i})}if(e.terminalPoint){const{x:t,y:i}=this.roundPoints?e.terminalPoint.round():e.terminalPoint;this.object.set({x2:t,y2:i}),this.points[1]=new r({x:t,y:i})}this.object.setCoords(),t&&this.event.fireEvent("moving",this)}get points(){return this._points}set points(e){this._points[0]=this.roundPoints?e[0].round():e[0],this._points[1]=this.roundPoints?e[1].round():e[1],this.updatePoint({initialPoint:this._points[0],terminalPoint:this._points[1]},!0)}_updateInternalObjectOptions(e){this.object.set(e)}dispose(){}changeToCoordinateMode(){const t=this.object,i=this;function n(i,r,n){if(!t.canvas)return{x:0,y:0};var{x1:s,x2:o,y1:a,y2:d,width:h,height:c}=n;let l,u;return 0===this.pointIndex?(l=h/2*(s<o?-1:1),u=c/2*(a<d?-1:1)):1===this.pointIndex&&(l=h/2*(s<o?1:-1),u=c/2*(a<d?1:-1)),e.util.transformPoint({x:l,y:u},e.util.multiplyTransformMatrices(n.canvas.viewportTransform,n.calcTransformMatrix()))}function s(e,t,n,s){var o=t.target,{x1:a,x2:d,y1:h,y2:c}=(t=o.controls[t.corner],o);let l,u;return u=0===t.pointIndex?(l={x:n,y:s},{x:d,y:c}):(l={x:a,y:h},{x:n,y:s}),i.updatePoint({initialPoint:new r(l),terminalPoint:new r(u)}),i.renderer?.fabric.fire("object:moving",{target:o}),!0}this.editingMode="coordinate",t.hasBorders=!1,t.padding=0,t.controls={p0:new e.Control({positionHandler:n,actionHandler:s,actionName:"modify-line",pointIndex:0}),p1:new e.Control({positionHandler:n,actionHandler:s,actionName:"modify-line",pointIndex:1})},this.renderer?.requestRender()}changeToSizeMode(){this.object.controls=e.Object.prototype.controls,this.object.hasBorders=!0,this.object.padding=6,this.editingMode="size",this.renderer?.requestRender()}getVector(){var[{x:e,y:t},{x:i,y:r}]=this.points;return[i-e,r-t]}get angle(){var t=this.getVector();let i=Math.acos(+t[1]/this.length);return 0<t[0]&&(i=2*Math.PI-i),(t=>e.util.radiansToDegrees(t))(i)}get symmetryAngle(){return 0<this.getVector()[0]?this.angle-180:this.angle}get length(){var[e,t]=this.getVector();return Math.sqrt(e**2+t**2)}}class M{core;eventListenerMap=new Map;constructor(e){this.core=new k({view:e})}addListener(e,t){if("selection:updated"===e){const i=e=>{t({prev:e.prev?O(e.prev):null,next:e.next?O(e.next):null})};this.core.renderableEvent.addListener(e,i),this.eventListenerMap.set(t,i)}else{const i=e=>{t({target:O(e.target)})};this.core.renderableEvent.addListener(e,i),this.eventListenerMap.set(t,i)}}removeListener(e,t){const i=this.eventListenerMap.get(t);i&&this.core.renderableEvent.removeListener(e,i)}add(e,t){this.core.addBulk([e].flat().map((e=>e.core)),t)}remove(e,t){this.core.removeBulk([e].flat().map((e=>e.core)),t)}getShapes(){return this.core.renderables.filter((e=>e instanceof S&&O(e))).map((e=>O(e)))}getActiveShape(){const e=this.core.getActiveRenderable();return e instanceof S?O(e):null}}class C{core;data;constructor(e){const{coordinates:t,data:i}=e;this.core=new S({points:[new r(t[0]),new r(t[1])],stroke:"black",strokeWidth:3,cornerSize:10}),this.core.changeToCoordinateMode(),this.core.data.shape=this,this.data=i??{}}get coordinates(){return[T(this.core.points[0]),T(this.core.points[1])]}}const T=e=>({x:e.x,y:e.y}),O=e=>e.data.shape;export{C as LineShape,M as Renderer};
